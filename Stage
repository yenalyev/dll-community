def remote = [:]
remote.name = 'staging'
remote.host = '138.68.106.228'
remote.allowAnyHosts = true

pipeline {
    agent any

    tools {
        maven "Maven 3.8.4"
    }

    environment {
        DOCKER_IMAGE = 'maximen/test'
        DOCKER_TAG = 'dll_stage'
        STAGING_PATH = '/home/dll_stage'
        COMPOSE_PATH = '/home/dll_stage/compose'
        APP_PORT = '8082'
        HEALTH_CHECK_URL = 'http://localhost:8082/actuator/health'
        
        // –í–∏—Ç—è–≥—É—î–º–æ –∫–æ—Ä–æ—Ç–∫–∏–π commit hash –¥–ª—è —Ç–µ–≥—É–≤–∞–Ω–Ω—è
        GIT_COMMIT_SHORT = sh(
            script: "git rev-parse --short HEAD",
            returnStdout: true
        ).trim()
    }

    stages {
        stage('Initialize') {
            steps {
                echo "Starting build for commit: ${GIT_COMMIT_SHORT}"
                echo "PATH = ${M2_HOME}/bin:${PATH}"
                echo "M2_HOME = /opt/maven"
            }
        }

        stage('Build Application') {
            steps {
                echo "=================== Building Application ======================="
                sh 'mvn -B -DskipTests clean package -Pstage'
            }
        }

        stage('Push to Docker Hub') {
            steps {
                echo "=================== Pushing to Docker Hub ======================="
                script {
                    // ‚úÖ –ë–ï–ó–ü–ï–ß–ù–û: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Jenkins credentials
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                            docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
                            docker push ${DOCKER_IMAGE}:${BUILD_NUMBER}
                            docker push ${DOCKER_IMAGE}:${GIT_COMMIT_SHORT}
                        """
                    }
                }
            }
        }



        stage('Deploy to Staging') {
            steps {
                echo "=================== Deploying to Staging ======================="
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'crm-stage-user',
                            usernameVariable: 'SSH_USER',
                            passwordVariable: 'SSH_PASS'
                        )
                    ]) {
                        remote.user = SSH_USER
                        remote.password = SSH_PASS
                        
                        // Pull –Ω–æ–≤–∏–π –æ–±—Ä–∞–∑
                        sshCommand(remote: remote, command: """
                            cd ${COMPOSE_PATH}
                            docker-compose pull app
                        """)
                        
                        // –ó—É–ø–∏–Ω–∏—Ç–∏ app (–∞–ª–µ –Ω–µ MySQL —ñ nginx!)
                        sshCommand(remote: remote, command: """
                            cd ${COMPOSE_PATH}
                            docker-compose stop app
                            docker-compose rm -f app
                        """)
                        
                        // –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–æ–≤–∏–π app
                        sshCommand(remote: remote, command: """
                            cd ${COMPOSE_PATH}
                            docker-compose up -d app
                        """)
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                echo "=================== Checking Application Health ======================="
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'crm-stage-user',
                            usernameVariable: 'SSH_USER',
                            passwordVariable: 'SSH_PASS'
                        )
                    ]) {
                        remote.user = SSH_USER
                        remote.password = SSH_PASS
                        
                        def healthCheckPassed = false
                        def maxAttempts = 10
                        def attempt = 0
                        
                        while (!healthCheckPassed && attempt < maxAttempts) {
                            attempt++
                            echo "Health check attempt ${attempt}/${maxAttempts}..."
                            
                            try {
                                def result = sshCommand(
                                    remote: remote,
                                    command: "curl -f ${HEALTH_CHECK_URL}",
                                    failOnError: false
                                )
                                
                                if (result == 0) {
                                    healthCheckPassed = true
                                    echo "‚úÖ Health check passed!"
                                } else {
                                    echo "‚è≥ Waiting 10 seconds before retry..."
                                    sleep 10
                                }
                            } catch (Exception e) {
                                echo "‚è≥ Waiting 10 seconds before retry..."
                                sleep 10
                            }
                        }
                        
                        if (!healthCheckPassed) {
                            error("‚ùå Health check failed after ${maxAttempts} attempts!")
                        }
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "=================== Verifying Deployment ======================="
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'crm-stage-user',
                            usernameVariable: 'SSH_USER',
                            passwordVariable: 'SSH_PASS'
                        )
                    ]) {
                        remote.user = SSH_USER
                        remote.password = SSH_PASS
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                        sshCommand(remote: remote, command: """
                            cd ${COMPOSE_PATH}
                            docker-compose ps app
                            docker-compose logs --tail=50 app
                        """)
                    }
                }
            }
        }

        stage('Cleanup') {
            steps {
                echo "=================== Cleaning Up ======================="
                script {
                    // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ Docker –æ–±—Ä–∞–∑–∏ –Ω–∞ Jenkins
                    sh """
                        docker image prune -f
                        docker images | grep ${DOCKER_IMAGE} | grep -v ${DOCKER_TAG} | \
                            grep -v ${BUILD_NUMBER} | grep -v ${GIT_COMMIT_SHORT} | \
                            awk '{print \$3}' | xargs -r docker rmi -f || true
                    """
                    
                    // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –æ–±—Ä–∞–∑–∏ –Ω–∞ staging
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'crm-stage-user',
                            usernameVariable: 'SSH_USER',
                            passwordVariable: 'SSH_PASS'
                        )
                    ]) {
                        remote.user = SSH_USER
                        remote.password = SSH_PASS
                        
                        sshCommand(remote: remote, command: """
                            docker image prune -f
                            docker images | grep ${DOCKER_IMAGE} | grep '<none>' | \
                                awk '{print \$3}' | xargs -r docker rmi -f || true
                        """)
                    }
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment successful!"
            echo "Application URL: http://138.68.106.228:${APP_PORT}"
            
            // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ email –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é
            // emailext(
            //     subject: "‚úÖ Deployment Successful - Build #${BUILD_NUMBER}",
            //     body: "Application deployed successfully to staging.",
            //     to: "your-email@example.com"
            // )
        }
        
        failure {
            echo "‚ùå Deployment failed!"
            
            script {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π rollback
                def previousBuild = BUILD_NUMBER.toInteger() - 1
                
                if (previousBuild > 0) {
                    echo "üîÑ Attempting automatic rollback to build #${previousBuild}..."
                    
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'crm-stage-user',
                            usernameVariable: 'SSH_USER',
                            passwordVariable: 'SSH_PASS'
                        )
                    ]) {
                        remote.user = SSH_USER
                        remote.password = SSH_PASS
                        
                        try {
                            sshCommand(remote: remote, command: """
                                cd ${COMPOSE_PATH}
                                docker-compose stop app
                                docker-compose rm -f app
                                docker pull ${DOCKER_IMAGE}:${previousBuild}
                                docker tag ${DOCKER_IMAGE}:${previousBuild} ${DOCKER_IMAGE}:${DOCKER_TAG}
                                docker-compose up -d app
                            """)
                            
                            echo "‚úÖ Rollback to build #${previousBuild} completed"
                        } catch (Exception e) {
                            echo "‚ùå Rollback failed: ${e.message}"
                        }
                    }
                }
            }
            
            // emailext(
            //     subject: "‚ùå Deployment Failed - Build #${BUILD_NUMBER}",
            //     body: "Application deployment failed. Check Jenkins logs.",
            //     to: "your-email@example.com"
            // )
        }
        
        always {
            // Cleanup workspace
            cleanWs()
        }
    }
}
