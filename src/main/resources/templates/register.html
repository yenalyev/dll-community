<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="#{auth.register.title}">Sign up</title>
</head>
<body>

<div layout:fragment="content">
    <section class="py-12 px-4 bg-gray-50 min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8">
            <!-- Logo -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2" th:text="#{app.name}">DLL Community</h1>
                <p class="text-gray-600" th:text="#{auth.register.title}">Створіть ваш обліковий запис</p>
            </div>

            <!-- Error Messages -->
            <div th:if="${#fields.hasErrors('registerDto')}"
                 class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                <ul class="list-disc list-inside space-y-1">
                    <li th:each="err : ${#fields.errors('registerDto')}" th:text="${err}">Error</li>
                </ul>
            </div>

            <!-- Registration Form -->
            <form method="post"
                  th:action="@{/{lang}/register(lang=${#locale.language})}"
                  th:object="${registerDto}"
                  class="space-y-5"
                  id="registrationForm">

                <!-- CSRF Token -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Full Name -->
                <div>
                    <label for="name" class="block text-sm font-semibold text-gray-900 mb-2" th:text="#{auth.name}">
                        Повне ім'я
                    </label>
                    <input type="text"
                           id="name"
                           th:field="*{name}"
                           th:placeholder="#{auth.name}"
                           class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:border-warning transition"
                           th:classappend="${#fields.hasErrors('name')} ? 'border-red-500' : 'border-gray-300'"
                           required>
                    <p th:if="${#fields.hasErrors('name')}"
                       th:errors="*{name}"
                       class="text-xs text-red-600 mt-1">Name error</p>
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-semibold text-gray-900 mb-2" th:text="#{auth.email}">
                        E-mail
                    </label>
                    <input type="email"
                           id="email"
                           th:field="*{email}"
                           th:placeholder="#{auth.email}"
                           class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:border-warning transition"
                           th:classappend="${#fields.hasErrors('email')} ? 'border-red-500' : 'border-gray-300'"
                           required>
                    <p th:if="${#fields.hasErrors('email')}"
                       th:errors="*{email}"
                       class="text-xs text-red-600 mt-1">Email error</p>
                </div>

                <!-- Password -->
                <div>
                    <label for="password" class="block text-sm font-semibold text-gray-900 mb-2" th:text="#{auth.password}">
                        Пароль
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="password"
                               th:field="*{password}"
                               th:placeholder="#{auth.password}"
                               class="w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:border-warning transition"
                               th:classappend="${#fields.hasErrors('password')} ? 'border-red-500' : 'border-gray-300'"
                               required
                               minlength="6">
                        <button type="button"
                                id="togglePassword"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="passwordStrength" class="mt-2 h-1 bg-gray-200 rounded-full overflow-hidden hidden">
                        <div id="strengthBar" class="h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="strengthText" class="text-xs mt-1 hidden"></p>
                    <p th:if="${#fields.hasErrors('password')}"
                       th:errors="*{password}"
                       class="text-xs text-red-600 mt-1">Password error</p>
                </div>

                <!-- Confirm Password -->
                <div>
                    <label for="confirmPassword" class="block text-sm font-semibold text-gray-900 mb-2" th:text="#{auth.password.confirm}">
                        Підтвердіть пароль
                    </label>
                    <input type="password"
                           id="confirmPassword"
                           name="confirmPassword"
                           th:placeholder="#{auth.password.confirm}"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                           required>
                    <p id="passwordMatch" class="text-xs mt-1 hidden"></p>
                </div>

                <!-- Terms Agreement -->
                <div class="flex items-start">
                    <input type="checkbox"
                           id="terms"
                           name="terms"
                           class="w-4 h-4 mt-1 rounded border-gray-300 text-warning focus:ring-warning"
                           required>
                    <label for="terms" class="ml-2 text-sm text-gray-700">
                        <span th:text="#{auth.terms.agree}">Я погоджуюсь з</span>
                        <a href="#terms" class="text-gray-900 font-semibold hover:underline" th:text="#{auth.terms.link}">умовами використання</a>
                        <span th:text="#{auth.and}">та</span>
                        <a href="#privacy" class="text-gray-900 font-semibold hover:underline" th:text="#{auth.privacy.link}">політикою конфіденційності</a>
                    </label>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                        class="w-full bg-warning text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-yellow-500 transition shadow-md hover:shadow-lg"
                        th:text="#{nav.signup}">
                    Зареєструватися
                </button>
            </form>

            <!-- Divider -->
            <div class="flex items-center my-6">
                <div class="flex-1 border-t border-gray-300"></div>
                <span class="px-4 text-sm text-gray-500" th:text="#{auth.or.continue}">або продовжити з</span>
                <div class="flex-1 border-t border-gray-300"></div>
            </div>

            <!-- Google Sign Up -->
            <a th:href="@{/oauth2/authorization/google}"
               class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 py-3 rounded-lg hover:bg-gray-50 transition font-semibold text-gray-900">
                <svg width="20" height="20" viewBox="0 0 16 16">
                    <path fill="#4285F4" d="M14.9 8.161c0-.476-.039-.954-.121-1.422h-6.64v2.695h3.802a3.24 3.24 0 01-1.407 2.127v1.75h2.269c1.332-1.22 2.097-3.02 2.097-5.15z"/>
                    <path fill="#34A853" d="M8.14 15c1.898 0 3.499-.62 4.665-1.69l-2.268-1.749c-.631.427-1.446.669-2.395.669-1.836 0-3.393-1.232-3.952-2.888H1.85v1.803A7.044 7.044 0 008.14 15z"/>
                    <path fill="#FBBC04" d="M4.187 9.342a4.17 4.17 0 010-2.68V4.859H1.849a6.97 6.97 0 000 6.286l2.338-1.803z"/>
                    <path fill="#EA4335" d="M8.14 3.77a3.837 3.837 0 012.7 1.05l2.01-1.999a6.786 6.786 0 00-4.71-1.82 7.042 7.042 0 00-6.29 3.858L4.186 6.66c.556-1.658 2.116-2.89 3.952-2.89z"/>
                </svg>
                <span th:text="#{auth.google}">Продовжити з Google</span>
            </a>

            <!-- Login Link -->
            <p class="text-center mt-6 text-gray-700">
                <span th:text="#{auth.have.account}">Вже маєте акаунт?</span>
                <a th:href="@{/login}" class="font-semibold text-gray-900 hover:underline" th:text="#{nav.login}">Увійти</a>
            </p>
        </div>
    </section>
</div>

<!-- JavaScript -->
<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        // Translations from messages
        const translations = {
            weak: /*[[#{password.strength.weak}]]*/ 'Слабкий',
            medium: /*[[#{password.strength.medium}]]*/ 'Середній',
            good: /*[[#{password.strength.good}]]*/ 'Хороший',
            excellent: /*[[#{password.strength.excellent}]]*/ 'Відмінний',
            matchSuccess: /*[[#{password.match.success}]]*/ '✓ Паролі співпадають',
            matchError: /*[[#{password.match.error}]]*/ '✗ Паролі не співпадають',
            passwordsMismatch: /*[[#{auth.error.passwords.match}]]*/ 'Паролі не співпадають!'
        };

        // Password visibility toggle
        const togglePassword = document.getElementById('togglePassword');
        const password = document.getElementById('password');
        const eyeIcon = document.getElementById('eyeIcon');

        if (togglePassword) {
            togglePassword.addEventListener('click', function() {
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);

                if (type === 'text') {
                    eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>';
                } else {
                    eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>';
                }
            });
        }

        // Password strength checker
        const passwordInput = document.getElementById('password');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        const passwordStrength = document.getElementById('passwordStrength');

        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const value = this.value;
                let strength = 0;

                if (value.length >= 6) strength++;
                if (value.match(/[a-z]/) && value.match(/[A-Z]/)) strength++;
                if (value.match(/[0-9]/)) strength++;
                if (value.match(/[^a-zA-Z0-9]/)) strength++;

                if (value.length > 0) {
                    passwordStrength.classList.remove('hidden');
                    strengthText.classList.remove('hidden');

                    const colors = ['#ef4444', '#f59e0b', '#eab308', '#22c55e'];
                    const texts = [translations.weak, translations.medium, translations.good, translations.excellent];
                    const widths = ['25%', '50%', '75%', '100%'];

                    if (strength > 0) {
                        strengthBar.style.width = widths[strength - 1];
                        strengthBar.style.backgroundColor = colors[strength - 1];
                        strengthText.textContent = texts[strength - 1];
                        strengthText.style.color = colors[strength - 1];
                    }
                } else {
                    passwordStrength.classList.add('hidden');
                    strengthText.classList.add('hidden');
                }
            });
        }

        // Password match checker
        const confirmPassword = document.getElementById('confirmPassword');
        const passwordMatch = document.getElementById('passwordMatch');

        if (confirmPassword) {
            confirmPassword.addEventListener('input', function() {
                if (this.value.length > 0) {
                    passwordMatch.classList.remove('hidden');
                    if (this.value === passwordInput.value) {
                        passwordMatch.textContent = translations.matchSuccess;
                        passwordMatch.className = 'text-xs mt-1 text-green-600';
                    } else {
                        passwordMatch.textContent = translations.matchError;
                        passwordMatch.className = 'text-xs mt-1 text-red-600';
                    }
                } else {
                    passwordMatch.classList.add('hidden');
                }
            });
        }

        // Form validation before submit
        const form = document.getElementById('registrationForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (passwordInput.value !== confirmPassword.value) {
                    e.preventDefault();
                    alert(translations.passwordsMismatch);
                    return false;
                }
            });
        }
    </script>
</th:block>

</body>
</html>
