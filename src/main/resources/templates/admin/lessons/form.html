<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}">
<head>
    <title th:text="${isEdit} ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É' : '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É'">Lesson Form</title>
</head>
<body>

<div layout:fragment="content" x-data="lessonForm()">

    <div class="mb-8">
        <a href="/admin/lessons" class="text-blue-600 hover:text-blue-700 flex items-center mb-4">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É
        </a>
        <h2 class="text-3xl font-bold text-gray-900 mb-2"
            th:text="${isEdit} ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É' : '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É'">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É</h2>
        <p class="text-gray-600">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É</p>
    </div>

    <div th:if="${error}"
         class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded">
        <p th:text="${error}"></p>
    </div>

    <form method="post"
          th:action="${isEdit} ? @{/admin/lessons/edit/{id}(id=${lesson.id})} : @{/admin/lessons/create}"
          th:object="${lesson}"
          class="space-y-6">

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label for="mainImageUrl" class="block text-sm font-semibold text-gray-900 mb-2">
                        URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    </label>
                    <input type="url"
                           id="mainImageUrl"
                           th:field="*{mainImageUrl}"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                           placeholder="https://example.com/image.jpg">
                </div>

                <div>
                    <label for="accessLevel" class="block text-sm font-semibold text-gray-900 mb-2">
                        –¢–∏–ø –¥–æ—Å—Ç—É–ø—É <span class="text-red-500">*</span>
                    </label>
                    <select id="accessLevel"
                            th:field="*{accessLevel}"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                            required>
                        <option th:each="level : ${accessLevels}"
                                th:value="${level}"
                                th:text="${level}">Access Level</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- –¶—ñ–Ω–∏ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900">–¶—ñ–Ω–∏</h3>
                <button type="button"
                        @click="addPrice()"
                        class="bg-warning text-gray-900 px-4 py-2 rounded-lg hover:bg-yellow-500 transition font-semibold text-sm">
                    + –î–æ–¥–∞—Ç–∏ —Ü—ñ–Ω—É
                </button>
            </div>

            <div class="space-y-4">
                <template x-for="(price, index) in prices" :key="index">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start gap-4">
                            <div class="flex-1 grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-900 mb-2">
                                        –í–∞–ª—é—Ç–∞ <span class="text-red-500">*</span>
                                    </label>
                                    <select x-model="price.currency"
                                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                            required>
                                        <option value="">–û–±–µ—Ä—ñ—Ç—å –≤–∞–ª—é—Ç—É</option>
                                        <option th:each="currency : ${currencies}"
                                                th:value="${currency}"
                                                th:text="${currency}">Currency</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-900 mb-2">
                                        –°—É–º–∞ <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number"
                                           x-model="price.amount"
                                           step="1"
                                           min="0"
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                           placeholder="–í –∫–æ–ø—ñ–π–∫–∞—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 10000 = 100.00)"
                                           required>
                                </div>
                            </div>
                            <button type="button"
                                    @click="removePrice(index)"
                                    class="mt-8 text-red-600 hover:text-red-800 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>

                <div x-show="prices.length === 0" class="text-center py-8 text-gray-500">
                    –ù–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö —Ü—ñ–Ω. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ —Ü—ñ–Ω—É" –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è.
                </div>
            </div>

            <div id="prices-hidden-inputs"></div>
        </div>

        <!-- –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900">–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —É—Ä–æ–∫—É</h3>
                <button type="button"
                        @click="addMaterial()"
                        class="bg-warning text-gray-900 px-4 py-2 rounded-lg hover:bg-yellow-500 transition font-semibold text-sm">
                    + –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª
                </button>
            </div>

            <div class="space-y-4">
                <template x-for="(material, index) in materials" :key="index">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start gap-4">
                            <div class="flex-1 space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                                            –¢–∏–ø –º–∞—Ç–µ—Ä—ñ–∞–ª—É <span class="text-red-500">*</span>
                                        </label>
                                        <select x-model="material.materialType"
                                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                                required>
                                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø</option>
                                            <option th:each="type : ${materialTypes}"
                                                    th:value="${type}"
                                                    th:text="${type}">Type</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                                            –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è <span class="text-red-500">*</span>
                                        </label>
                                        <input type="number"
                                               x-model="material.sortOrder"
                                               min="0"
                                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                               required>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-900 mb-2">
                                        –ù–∞–∑–≤–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)
                                    </label>
                                    <input type="text"
                                           x-model="material.title"
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                           placeholder="–ù–∞–∑–≤–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª—É">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-900 mb-2">
                                        –ö–æ–Ω—Ç–µ–Ω—Ç <span class="text-red-500">*</span>
                                    </label>
                                    <textarea x-model="material.content"
                                              rows="3"
                                              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                              placeholder="URL –¥–ª—è PDF/LINK/IMAGE –∞–±–æ —Ç–µ–∫—Å—Ç –¥–ª—è TEXT_BLOCK"
                                              required></textarea>
                                </div>
                            </div>
                            <button type="button"
                                    @click="removeMaterial(index)"
                                    class="mt-8 text-red-600 hover:text-red-800 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>

                <div x-show="materials.length === 0" class="text-center py-8 text-gray-500">
                    –ù–µ–º–∞—î –¥–æ–¥–∞–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª" –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è.
                </div>
            </div>

            <div id="materials-hidden-inputs"></div>
        </div>

        <!-- –ê—Ç—Ä–∏–±—É—Ç–∏ —É—Ä–æ–∫—É -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–ê—Ç—Ä–∏–±—É—Ç–∏ —É—Ä–æ–∫—É</h3>

            <div class="space-y-6">
                <th:block th:each="attr, iterStat : ${attributes}">
                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4"
                            th:text="${attr.translations.get('uk')}">–ê—Ç—Ä–∏–±—É—Ç</h4>

                        <div th:if="${attr.type == 'select' || attr.type == 'multiselect'}">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <th:block th:each="option, optIterStat : ${attr.options}">
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-warning hover:bg-yellow-50 transition cursor-pointer">
                                        <input type="checkbox"
                                               th:data-attribute-id="${attr.id}"
                                               th:data-option-id="${option.id}"
                                               class="attribute-checkbox w-5 h-5 text-warning border-gray-300 rounded focus:ring-warning focus:ring-2"
                                               x-model="selectedOptions"
                                               th:value="|${attr.id}-${option.id}|">
                                        <span class="ml-3 text-sm font-medium text-gray-900"
                                              th:text="${option.translations.get('uk')}">–û–ø—Ü—ñ—è</span>
                                    </label>
                                </th:block>
                            </div>
                        </div>

                        <div th:if="${attr.type == 'text'}">
                            <input type="text"
                                   th:data-attribute-id="${attr.id}"
                                   class="attribute-text w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                   th:attr=":value='getTextValue(' + ${attr.id} + ')',
                                    @input='updateTextValue(' + ${attr.id} + ', $event.target.value)'"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è">
                        </div>

                        <div th:if="${attr.type == 'number'}">
                            <input type="number"
                                   step="0.01"
                                   th:data-attribute-id="${attr.id}"
                                   class="attribute-number w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                   th:attr=":value='getNumberValue(' + ${attr.id} + ')',
                                    @input='updateNumberValue(' + ${attr.id} + ', $event.target.value)'"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ">
                        </div>
                    </div>
                </th:block>

                <div th:if="${#lists.isEmpty(attributes)}"
                     class="text-center py-8 text-gray-500">
                    –ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∞—Ç—Ä–∏–±—É—Ç—ñ–≤. –°—Ç–≤–æ—Ä—ñ—Ç—å –∞—Ç—Ä–∏–±—É—Ç–∏ –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–ê—Ç—Ä–∏–±—É—Ç–∏".
                </div>
            </div>

            <div id="attributes-hidden-inputs"></div>
        </div>

        <!-- –ü–µ—Ä–µ–∫–ª–∞–¥–∏ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8" x-data="{ activeTab: 'uk' }">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–ü–µ—Ä–µ–∫–ª–∞–¥–∏</h3>

            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-4">
                    <button type="button"
                            @click="activeTab = 'uk'"
                            :class="activeTab === 'uk' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞
                    </button>
                    <button type="button"
                            @click="activeTab = 'en'"
                            :class="activeTab === 'en' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá¨üáß English
                    </button>
                    <button type="button"
                            @click="activeTab = 'de'"
                            :class="activeTab === 'de' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá©üá™ Deutsch
                    </button>
                </nav>
            </div>

            <div>
                <!-- –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ -->
                <div x-show="activeTab === 'uk'" class="space-y-4">
                    <input type="hidden" th:field="*{translations['uk'].lang}">
                    <input type="hidden" th:field="*{translations['uk'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            –ù–∞–∑–≤–∞ <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['uk'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            –û–ø–∏—Å
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['uk'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta –æ–ø–∏—Å (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['uk'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">–ú–∞–∫—Å–∏–º—É–º 160 —Å–∏–º–≤–æ–ª—ñ–≤</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['uk'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">–¢—ñ–ª—å–∫–∏ –º–∞–ª—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ –¥–µ—Ñ—ñ—Å–∏</p>
                    </div>
                </div>

                <!-- English -->
                <div x-show="activeTab === 'en'" class="space-y-4" style="display: none;">
                    <input type="hidden" th:field="*{translations['en'].lang}">
                    <input type="hidden" th:field="*{translations['en'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Title <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['en'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Description
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['en'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta description (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['en'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Maximum 160 characters</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['en'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Only lowercase letters, numbers and hyphens</p>
                    </div>
                </div>

                <!-- Deutsch -->
                <div x-show="activeTab === 'de'" class="space-y-4" style="display: none;">
                    <input type="hidden" th:field="*{translations['de'].lang}">
                    <input type="hidden" th:field="*{translations['de'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Titel <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['de'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Beschreibung
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['de'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta-Beschreibung (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['de'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Maximal 160 Zeichen</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['de'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Nur Kleinbuchstaben, Zahlen und Bindestriche</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="flex items-center justify-end gap-4">
            <a href="/admin/lessons"
               class="px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition">
                –°–∫–∞—Å—É–≤–∞—Ç–∏
            </a>
            <button type="submit"
                    class="px-6 py-3 bg-warning text-gray-900 rounded-lg font-semibold hover:bg-yellow-500 transition">
                <span th:text="${isEdit} ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ —É—Ä–æ–∫'">–°—Ç–≤–æ—Ä–∏—Ç–∏</span>
            </button>
        </div>
    </form>

</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        function lessonForm() {
            return {
                // –ê—Ç—Ä–∏–±—É—Ç–∏
                selectedOptions: [],
                textValues: {},
                numberValues: {},

                // –¶—ñ–Ω–∏
                prices: [],

                // –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏
                materials: [],

                init() {
                    console.log('Lesson form initialized');

                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ –¥–∞–Ω—ñ
                    this.loadExistingAttributes();
                    this.loadExistingPrices();
                    this.loadExistingMaterials();

                    // Watchers
                    this.$watch('selectedOptions', () => this.generateHiddenInputs());
                    this.$watch('textValues', () => this.generateHiddenInputs());
                    this.$watch('numberValues', () => this.generateHiddenInputs());
                    this.$watch('prices', () => this.generatePriceInputs());
                    this.$watch('materials', () => this.generateMaterialInputs());
                },

                // ========== –¶–Ü–ù–ò ==========

                loadExistingPrices() {
                    /*[# th:if="${lesson != null and lesson.prices != null}"]*/
                    const existingPrices = /*[[${lesson.prices}]]*/ [];
                    console.log('Loading existing prices:', existingPrices);

                    this.prices = existingPrices.map(p => ({
                        id: p.id,
                        currency: p.currency,
                        amount: p.amount
                    }));
                    /*[/]*/
                },

                addPrice() {
                    this.prices.push({
                        id: null,
                        currency: '',
                        amount: 0
                    });
                },

                removePrice(index) {
                    this.prices.splice(index, 1);
                },

                generatePriceInputs() {
                    const container = document.getElementById('prices-hidden-inputs');
                    if (!container) return;

                    container.innerHTML = '';

                    this.prices.forEach((price, index) => {
                        if (price.id) {
                            container.innerHTML += `<input type="hidden" name="prices[${index}].id" value="${price.id}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="prices[${index}].currency" value="${price.currency}">`;
                        container.innerHTML += `<input type="hidden" name="prices[${index}].amount" value="${price.amount}">`;
                    });

                    console.log('Generated', this.prices.length, 'price inputs');
                },

                // ========== –ú–ê–¢–ï–†–Ü–ê–õ–ò ==========

                loadExistingMaterials() {
                    /*[# th:if="${lesson != null and lesson.materials != null}"]*/
                    const existingMaterials = /*[[${lesson.materials}]]*/ [];
                    console.log('Loading existing materials:', existingMaterials);

                    this.materials = existingMaterials.map(m => ({
                        id: m.id,
                        materialType: m.materialType,
                        title: m.title || '',
                        content: m.content,
                        sortOrder: m.sortOrder
                    }));
                    /*[/]*/
                },

                addMaterial() {
                    this.materials.push({
                        id: null,
                        materialType: '',
                        title: '',
                        content: '',
                        sortOrder: this.materials.length
                    });
                },

                removeMaterial(index) {
                    this.materials.splice(index, 1);
                },

                generateMaterialInputs() {
                    const container = document.getElementById('materials-hidden-inputs');
                    if (!container) return;

                    container.innerHTML = '';

                    this.materials.forEach((material, index) => {
                        if (material.id) {
                            container.innerHTML += `<input type="hidden" name="materials[${index}].id" value="${material.id}">`;
                        }
                        // –í–ò–ü–†–ê–í–õ–ï–ù–û: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ material.materialType –∑–∞–º—ñ—Å—Ç—å [[${type}]]
                        container.innerHTML += `<input type="hidden" name="materials[${index}].materialType" value="${material.materialType}">`;
                        container.innerHTML += `<input type="hidden" name="materials[${index}].title" value="${this.escapeHtml(material.title)}">`;
                        container.innerHTML += `<input type="hidden" name="materials[${index}].content" value="${this.escapeHtml(material.content)}">`;
                        container.innerHTML += `<input type="hidden" name="materials[${index}].sortOrder" value="${material.sortOrder}">`;
                    });

                    console.log('Generated', this.materials.length, 'material inputs');
                },

                // ========== –ê–¢–†–ò–ë–£–¢–ò ==========

                loadExistingAttributes() {
                    /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                    const existingAttrs = /*[[${lesson.attributes}]]*/ [];
                    console.log('Loading existing attributes:', existingAttrs);

                    let loadedOptions = [];
                    let loadedText = {};
                    let loadedNumbers = {};

                    existingAttrs.forEach(attr => {
                        if (attr.optionId) {
                            loadedOptions.push(`${attr.attributeId}-${attr.optionId}`);
                        } else if (attr.textValue) {
                            loadedText[attr.attributeId] = attr.textValue;
                        } else if (attr.numberValue != null) {
                            loadedNumbers[attr.attributeId] = attr.numberValue;
                        }
                    });

                    this.selectedOptions = loadedOptions;
                    this.textValues = loadedText;
                    this.numberValues = loadedNumbers;

                    this.$nextTick(() => {
                        this.generateHiddenInputs();
                    });
                    /*[/]*/
                },

                updateTextValue(attributeId, value) {
                    if (value && value.trim()) {
                        this.textValues[attributeId] = value;
                    } else {
                        delete this.textValues[attributeId];
                    }
                },

                updateNumberValue(attributeId, value) {
                    if (value !== '' && value !== null) {
                        this.numberValues[attributeId] = value;
                    } else {
                        delete this.numberValues[attributeId];
                    }
                },

                getTextValue(attributeId) {
                    return this.textValues[attributeId] || '';
                },

                getNumberValue(attributeId) {
                    return this.numberValues[attributeId] || '';
                },

                generateHiddenInputs() {
                    const container = document.getElementById('attributes-hidden-inputs');
                    if (!container) return;

                    container.innerHTML = '';
                    let index = 0;

                    // Select/multiselect
                    this.selectedOptions.forEach(value => {
                        const [attributeId, optionId] = value.split('-');

                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) &&
                            String(a.optionId) === String(optionId)
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].optionId" value="${optionId}">`;
                        index++;
                    });

                    // Text
                    Object.keys(this.textValues).forEach(attributeId => {
                        const value = this.textValues[attributeId];
                        if (!value || !value.trim()) return;

                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) && a.textValue
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].textValue" value="${this.escapeHtml(value)}">`;
                        index++;
                    });

                    // Number
                    Object.keys(this.numberValues).forEach(attributeId => {
                        const value = this.numberValues[attributeId];
                        if (value === '' || value === null) return;

                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) && a.numberValue != null
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].numberValue" value="${value}">`;
                        index++;
                    });

                    console.log('Generated', index, 'attribute inputs');
                },

                escapeHtml(text) {
                    if (typeof text !== 'string') return text;
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return text.replace(/[&<>"']/g, m => map[m]);
                }
            }
        }
    </script>
</th:block>

</body>
</html>