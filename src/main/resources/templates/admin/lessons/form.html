<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}">
<head>
    <title th:text="${isEdit} ? 'Edit Lesson' : 'Create Lesson'">Lesson Form</title>
</head>
<body>

<div layout:fragment="content" x-data="lessonForm()">

    <div class="mb-8">
        <a href="/admin/lessons" class="text-blue-600 hover:text-blue-700 flex items-center mb-4">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É
        </a>
        <h2 class="text-3xl font-bold text-gray-900 mb-2"
            th:text="${isEdit} ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É' : '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É'">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É</h2>
        <p class="text-gray-600">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É</p>
    </div>

    <div th:if="${error}"
         class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded">
        <p th:text="${error}"></p>
    </div>

    <form method="post"
          th:action="${isEdit} ? @{/admin/lessons/edit/{id}(id=${lesson.id})} : @{/admin/lessons/create}"
          th:object="${lesson}"
          class="space-y-6">

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label for="mainImageUrl" class="block text-sm font-semibold text-gray-900 mb-2">
                        URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    </label>
                    <input type="url"
                           id="mainImageUrl"
                           th:field="*{mainImageUrl}"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                           placeholder="https://example.com/image.jpg">
                </div>

                <div>
                    <label for="accessLevel" class="block text-sm font-semibold text-gray-900 mb-2">
                        –¢–∏–ø –¥–æ—Å—Ç—É–ø—É <span class="text-red-500">*</span>
                    </label>
                    <select id="accessLevel"
                            th:field="*{accessLevel}"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                            required>
                        <option th:each="level : ${accessLevels}"
                                th:value="${level}"
                                th:text="${level}">Access Level</option>
                    </select>
                </div>
            </div>
        </div>

<!--        –ê—Ç—Ä–∏–±—É—Ç–∏ —É—Ä–æ–∫—É-->

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–ê—Ç—Ä–∏–±—É—Ç–∏ —É—Ä–æ–∫—É</h3>

            <div class="space-y-6">
                <th:block th:each="attr, iterStat : ${attributes}">
                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4"
                            th:text="${attr.translations.get('uk')}">–ê—Ç—Ä–∏–±—É—Ç</h4>

                        <div th:if="${attr.type == 'select' || attr.type == 'multiselect'}">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <th:block th:each="option, optIterStat : ${attr.options}">
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-warning hover:bg-yellow-50 transition cursor-pointer">

                                        <input type="checkbox"
                                               th:data-attribute-id="${attr.id}"
                                               th:data-option-id="${option.id}"
                                               class="attribute-checkbox w-5 h-5 text-warning border-gray-300 rounded focus:ring-warning focus:ring-2"
                                               x-model="selectedOptions"
                                               th:value="|${attr.id}-${option.id}|">
                                        <span class="ml-3 text-sm font-medium text-gray-900"
                                              th:text="${option.translations.get('uk')}">–û–ø—Ü—ñ—è</span>
                                    </label>
                                </th:block>
                            </div>
                        </div>

                        <div th:if="${attr.type == 'text'}">
                            <input type="text"
                                   th:data-attribute-id="${attr.id}"
                                   class="attribute-text w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                   th:attr=":value='getTextValue(' + ${attr.id} + ')',
                                    @input='updateTextValue(' + ${attr.id} + ', $event.target.value)'"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è">
                        </div>

                        <div th:if="${attr.type == 'number'}">
                            <input type="number"
                                   step="0.01"
                                   th:data-attribute-id="${attr.id}"
                                   class="attribute-number w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                   th:attr=":value='getNumberValue(' + ${attr.id} + ')',
                                    @input='updateNumberValue(' + ${attr.id} + ', $event.target.value)'"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ">
                        </div>
                    </div>
                </th:block>

                <div th:if="${#lists.isEmpty(attributes)}"
                     class="text-center py-8 text-gray-500">
                    –ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∞—Ç—Ä–∏–±—É—Ç—ñ–≤. –°—Ç–≤–æ—Ä—ñ—Ç—å –∞—Ç—Ä–∏–±—É—Ç–∏ –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–ê—Ç—Ä–∏–±—É—Ç–∏".
                </div>
            </div>

            <div id="attributes-hidden-inputs">
            </div>
        </div>


<!--        –¢–µ–∫—Å—Ç–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ —É—Ä–æ–∫—É-->

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8" x-data="{ activeTab: 'uk' }">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–ü–µ—Ä–µ–∫–ª–∞–¥–∏</h3>

            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-4">
                    <button type="button"
                            @click="activeTab = 'uk'"
                            :class="activeTab === 'uk' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞
                    </button>
                    <button type="button"
                            @click="activeTab = 'en'"
                            :class="activeTab === 'en' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá¨üáß English
                    </button>
                    <button type="button"
                            @click="activeTab = 'de'"
                            :class="activeTab === 'de' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá©üá™ Deutsch
                    </button>
                </nav>
            </div>

            <div>
                <div x-show="activeTab === 'uk'" class="space-y-4">
                    <input type="hidden" th:field="*{translations['uk'].lang}">
                    <input type="hidden" th:field="*{translations['uk'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            –ù–∞–∑–≤–∞ <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['uk'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            –û–ø–∏—Å
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['uk'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta –æ–ø–∏—Å (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['uk'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">–ú–∞–∫—Å–∏–º—É–º 160 —Å–∏–º–≤–æ–ª—ñ–≤</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['uk'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">–¢—ñ–ª—å–∫–∏ –º–∞–ª—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ –¥–µ—Ñ—ñ—Å–∏</p>
                    </div>
                </div>

                <div x-show="activeTab === 'en'" class="space-y-4" style="display: none;">
                    <input type="hidden" th:field="*{translations['en'].lang}">
                    <input type="hidden" th:field="*{translations['en'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Title <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['en'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Description
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['en'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta description (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['en'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Maximum 160 characters</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['en'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Only lowercase letters, numbers and hyphens</p>
                    </div>
                </div>

                <div x-show="activeTab === 'de'" class="space-y-4" style="display: none;">
                    <input type="hidden" th:field="*{translations['de'].lang}">
                    <input type="hidden" th:field="*{translations['de'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Titel <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['de'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Beschreibung
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['de'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta-Beschreibung (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['de'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Maximal 160 Zeichen</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['de'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Nur Kleinbuchstaben, Zahlen und Bindestriche</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end gap-4">
            <a href="/admin/lessons"
               class="px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition">
                –°–∫–∞—Å—É–≤–∞—Ç–∏
            </a>
            <button type="submit"
                    class="px-6 py-3 bg-warning text-gray-900 rounded-lg font-semibold hover:bg-yellow-500 transition">
                <span th:text="${isEdit} ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ —É—Ä–æ–∫'">–°—Ç–≤–æ—Ä–∏—Ç–∏</span>
            </button>
        </div>
    </form>

</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        function lessonForm() {
            return {
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±—Ä–∞–Ω—ñ –æ–ø—Ü—ñ—ó —É —Ñ–æ—Ä–º–∞—Ç—ñ "attributeId-optionId"
                selectedOptions: [],

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤—ñ —Ç–∞ —á–∏—Å–ª–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
                textValues: {},
                numberValues: {},

                init() {
                    console.log('Lesson form initialized');

                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ
                    this.loadExistingAttributes();

                    // –ì–µ–Ω–µ—Ä—É—î–º–æ hidden inputs –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ç–∞ –ø—Ä–∏ –∑–º—ñ–Ω–∞—Ö
                    // $watch —Å–ø—Ä–∞—Ü—é—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –∫–æ–ª–∏ loadExistingAttributes –æ–Ω–æ–≤–∏—Ç—å selectedOptions
                    this.$watch('selectedOptions', () => this.generateHiddenInputs());
                    this.$watch('textValues', () => this.generateHiddenInputs());
                    this.$watch('numberValues', () => this.generateHiddenInputs());
                },

                loadExistingAttributes() {
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ –∞—Ç—Ä–∏–±—É—Ç–∏ –∑ Thymeleaf
                    /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                    const existingAttrs = /*[[${lesson.attributes}]]*/ [];
                    console.log('Loading existing attributes:', existingAttrs);

                    // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤—ñ –º–∞—Å–∏–≤–∏, —â–æ–± –Ω–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ $watch –Ω–∞ –∫–æ–∂–Ω—ñ–π —ñ—Ç–µ—Ä–∞—Ü—ñ—ó
                    let loadedOptions = [];
                    let loadedText = {};
                    let loadedNumbers = {};

                    existingAttrs.forEach(attr => {
                        if (attr.optionId) {
                            // Select/multiselect –∞—Ç—Ä–∏–±—É—Ç–∏
                            const value = `${attr.attributeId}-${attr.optionId}`;
                            loadedOptions.push(value);
                            console.log('Loaded option:', value);

                        } else if (attr.textValue) {
                            // Text –∞—Ç—Ä–∏–±—É—Ç–∏
                            loadedText[attr.attributeId] = attr.textValue;
                            console.log('Loaded text:', attr.attributeId, '=', attr.textValue);

                        } else if (attr.numberValue != null) {
                            // Number –∞—Ç—Ä–∏–±—É—Ç–∏
                            loadedNumbers[attr.attributeId] = attr.numberValue;
                            console.log('Loaded number:', attr.attributeId, '=', attr.numberValue);
                        }
                    });

                    // –ü—Ä–∏—Å–≤–æ—é—î–º–æ –æ–¥–∏–Ω —Ä–∞–∑, —â–æ–± Alpine (x-model) –æ–Ω–æ–≤–∏–≤ UI
                    // —ñ —â–æ–± —Å–ø—Ä–∞—Ü—é–≤–∞–≤ $watch
                    this.selectedOptions = loadedOptions;
                    this.textValues = loadedText;
                    this.numberValues = loadedNumbers;

                    // x-model –æ–Ω–æ–≤–∏—Ç—å —á–µ–∫–±–æ–∫—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
                    // $watch –∑–≥–µ–Ω–µ—Ä—É—î hidden inputs –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.

                    // –ú–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ generateHiddenInputs() —Ç—É—Ç –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ,
                    // —è–∫—â–æ —Ñ–æ—Ä–º–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –¥—É–∂–µ —à–≤–∏–¥–∫–æ
                    this.$nextTick(() => {
                        this.generateHiddenInputs();
                    });

                    /*[/]*/
                },

                // *** –ó–ú–Ü–ù–ê ***: –§—É–Ω–∫—Ü—ñ—è syncCheckboxes –≤–∏–¥–∞–ª–µ–Ω–∞.
                // x-model –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î —Å—Ç–∞–Ω.

                // *** –ó–ú–Ü–ù–ê ***: –§—É–Ω–∫—Ü—ñ—è updateAttributeSelection –≤–∏–¥–∞–ª–µ–Ω–∞.
                // x-model –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î –º–∞—Å–∏–≤ selectedOptions.

                updateTextValue(attributeId, value) {
                    if (value && value.trim()) {
                        this.textValues[attributeId] = value;
                    } else {
                        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ delete, —â–æ–± $watch —Å–ø—Ä–∞—Ü—é–≤–∞–≤
                        delete this.textValues[attributeId];
                    }
                    console.log('Updated text values:', this.textValues);
                },

                updateNumberValue(attributeId, value) {
                    if (value !== '' && value !== null) {
                        this.numberValues[attributeId] = value;
                    } else {
                        delete this.numberValues[attributeId];
                    }
                    console.log('Updated number values:', this.numberValues);
                },

                getTextValue(attributeId) {
                    return this.textValues[attributeId] || '';
                },

                getNumberValue(attributeId) {
                    return this.numberValues[attributeId] || '';
                },

                generateHiddenInputs() {
                    const container = document.getElementById('attributes-hidden-inputs');
                    if (!container) {
                        console.error('Hidden inputs container not found!');
                        return;
                    }

                    container.innerHTML = '';
                    let index = 0;

                    // –î–æ–¥–∞—î–º–æ hidden inputs –¥–ª—è –æ–±—Ä–∞–Ω–∏—Ö –æ–ø—Ü—ñ–π (select/multiselect)
                    this.selectedOptions.forEach(value => {
                        const [attributeId, optionId] = value.split('-');

                        // –®—É–∫–∞—î–º–æ —ñ—Å–Ω—É—é—á–∏–π ID (–ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ)
                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) &&
                            String(a.optionId) === String(optionId)
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        // ID (—è–∫—â–æ —ñ—Å–Ω—É—î - –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è)
                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }

                        // Attribute ID
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;

                        // Option ID
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].optionId" value="${optionId}">`;

                        index++;
                    });

                    // –î–æ–¥–∞—î–º–æ hidden inputs –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –∑–Ω–∞—á–µ–Ω—å
                    Object.keys(this.textValues).forEach(attributeId => {
                        const value = this.textValues[attributeId];
                        if (!value || !value.trim()) return;

                        // –®—É–∫–∞—î–º–æ —ñ—Å–Ω—É—é—á–∏–π ID
                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) && a.textValue
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }

                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].textValue" value="${this.escapeHtml(value)}">`;

                        index++;
                    });

                    // –î–æ–¥–∞—î–º–æ hidden inputs –¥–ª—è —á–∏—Å–ª–æ–≤–∏—Ö –∑–Ω–∞—á–µ–Ω—å
                    Object.keys(this.numberValues).forEach(attributeId => {
                        const value = this.numberValues[attributeId];
                        if (value === '' || value === null) return;

                        // –®—É–∫–∞—î–º–æ —ñ—Å–Ω—É—é—á–∏–π ID
                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) && a.numberValue != null
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }

                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].numberValue" value="${value}">`;

                        index++;
                    });

                    console.log('Generated', index, 'attribute inputs');
                },

                escapeHtml(text) {
                    if (typeof text !== 'string') return text;
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return text.replace(/[&<>"']/g, m => map[m]);
                }
            }
        }
    </script>
</th:block>

</body>
</html>
