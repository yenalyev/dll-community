<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}" xmlns:x-bind="http://www.w3.org/1999/xhtml">
<head>
    <title th:text="${isEdit} ? 'Edit Lesson' : 'Create Lesson'">Lesson Form</title>
</head>
<body>

<div layout:fragment="content" x-data="lessonForm()">

    <div class="mb-8">
        <a href="/admin/lessons" class="text-blue-600 hover:text-blue-700 flex items-center mb-4">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É
        </a>
        <h2 class="text-3xl font-bold text-gray-900 mb-2"
            th:text="${isEdit} ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É' : '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É'">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É</h2>
        <p class="text-gray-600">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É</p>
    </div>

    <div th:if="${error}"
         class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded">
        <p th:text="${error}"></p>
    </div>

    <form method="post"
          th:action="${isEdit} ? @{/admin/lessons/edit/{id}(id=${lesson.id})} : @{/admin/lessons/create}"
          th:object="${lesson}"
          class="space-y-6">

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label for="mainImageUrl" class="block text-sm font-semibold text-gray-900 mb-2">
                        URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    </label>
                    <input type="url"
                           id="mainImageUrl"
                           th:field="*{mainImageUrl}"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                           placeholder="https://example.com/image.jpg">
                </div>

                <div>
                    <label for="accessLevel" class="block text-sm font-semibold text-gray-900 mb-2">
                        –¢–∏–ø –¥–æ—Å—Ç—É–ø—É <span class="text-red-500">*</span>
                    </label>
                    <select id="accessLevel"
                            th:field="*{accessLevel}"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                            required>
                        <option th:each="level : ${accessLevels}"
                                th:value="${level}"
                                th:text="${level}">Access Level</option>
                    </select>
                </div>
            </div>
        </div>

<!--        –ê—Ç—Ä–∏–±—É—Ç–∏ —É—Ä–æ–∫—É-->

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–ê—Ç—Ä–∏–±—É—Ç–∏ —É—Ä–æ–∫—É</h3>

            <div class="space-y-6">
                <th:block th:each="attr, iterStat : ${attributes}">
                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4"
                            th:text="${attr.translations.get('uk')}">–ê—Ç—Ä–∏–±—É—Ç</h4>

                        <div th:if="${attr.type == 'select' || attr.type == 'multiselect'}">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <th:block th:each="option, optIterStat : ${attr.options}">
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-warning hover:bg-yellow-50 transition cursor-pointer">

                                        <input type="checkbox"
                                               th:data-attribute-id="${attr.id}"
                                               th:data-option-id="${option.id}"
                                               class="attribute-checkbox w-5 h-5 text-warning border-gray-300 rounded focus:ring-warning focus:ring-2"
                                               x-model="selectedOptions"
                                               th:value="|${attr.id}-${option.id}|">
                                        <span class="ml-3 text-sm font-medium text-gray-900"
                                              th:text="${option.translations.get('uk')}">–û–ø—Ü—ñ—è</span>
                                    </label>
                                </th:block>
                            </div>
                        </div>

                        <div th:if="${attr.type == 'text'}">
                            <input type="text"
                                   th:data-attribute-id="${attr.id}"
                                   class="attribute-text w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                   th:attr=":value='getTextValue(' + ${attr.id} + ')',
                                    @input='updateTextValue(' + ${attr.id} + ', $event.target.value)'"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è">
                        </div>

                        <div th:if="${attr.type == 'number'}">
                            <input type="number"
                                   step="0.01"
                                   th:data-attribute-id="${attr.id}"
                                   class="attribute-number w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                   th:attr=":value='getNumberValue(' + ${attr.id} + ')',
                                    @input='updateNumberValue(' + ${attr.id} + ', $event.target.value)'"
                                   placeholder="–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ">
                        </div>
                    </div>
                </th:block>

                <div th:if="${#lists.isEmpty(attributes)}"
                     class="text-center py-8 text-gray-500">
                    –ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∞—Ç—Ä–∏–±—É—Ç—ñ–≤. –°—Ç–≤–æ—Ä—ñ—Ç—å –∞—Ç—Ä–∏–±—É—Ç–∏ –≤ —Ä–æ–∑–¥—ñ–ª—ñ "–ê—Ç—Ä–∏–±—É—Ç–∏".
                </div>
            </div>

            <div id="attributes-hidden-inputs">
            </div>
        </div>

        <!-- –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —É—Ä–æ–∫—É -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900">–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ —É—Ä–æ–∫—É</h3>
                <button type="button"
                        @click="addMaterial()"
                        class="px-4 py-2 bg-warning text-gray-900 rounded-lg font-semibold hover:bg-yellow-500 transition flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª
                </button>
            </div>

            <div class="space-y-4">
                <template x-for="(material, index) in materials" :key="index">
                    <div class="border-2 border-gray-200 rounded-lg p-6 relative">
                        <button type="button"
                                @click="removeMaterial(index)"
                                class="absolute top-4 right-4 text-red-600 hover:text-red-700 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pr-12">
                            <!-- –¢–∏–ø –º–∞—Ç–µ—Ä—ñ–∞–ª—É -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-900 mb-2">
                                    –¢–∏–ø –º–∞—Ç–µ—Ä—ñ–∞–ª—É <span class="text-red-500">*</span>
                                </label>
                                <select x-model="material.materialType"
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition">
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø</option>
                                    <option th:each="type : ${materialTypes}"
                                            th:value="${type}"
                                            th:text="${type}"
                                            x-bind:value="type">Type</option>
                                </select>
                            </div>

                            <!-- –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-900 mb-2">
                                    –ü–æ—Ä—è–¥–æ–∫
                                </label>
                                <input type="number"
                                       x-model="material.sortOrder"
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                       placeholder="0">
                            </div>

                            <!-- –ù–∞–∑–≤–∞ -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-900 mb-2">
                                    –ù–∞–∑–≤–∞
                                </label>
                                <input type="text"
                                       x-model="material.title"
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                       placeholder="–ù–∞–∑–≤–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª—É">
                            </div>

                            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç (URL –∞–±–æ —Ç–µ–∫—Å—Ç) -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-900 mb-2">
                                    <span x-show="material.materialType === 'TEXT_BLOCK'">–¢–µ–∫—Å—Ç</span>
                                    <span x-show="material.materialType !== 'TEXT_BLOCK'">URL</span>
                                    <span class="text-red-500">*</span>
                                </label>
                                <textarea x-show="material.materialType === 'TEXT_BLOCK'"
                                          x-model="material.content"
                                          rows="4"
                                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                          placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç"></textarea>
                                <input x-show="material.materialType !== 'TEXT_BLOCK'"
                                       type="url"
                                       x-model="material.content"
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                                       placeholder="https://example.com/file.pdf">
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="materials.length === 0"
                     class="text-center py-8 text-gray-500 border-2 border-dashed border-gray-300 rounded-lg">
                    –ù–µ–º–∞—î –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª" —â–æ–± –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä—à–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª.
                </div>
            </div>

            <!-- Hidden inputs –¥–ª—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ -->
            <div id="materials-hidden-inputs"></div>
        </div>


<!--        –¢–µ–∫—Å—Ç–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ —É—Ä–æ–∫—É-->

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8" x-data="{ activeTab: 'uk' }">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">–ü–µ—Ä–µ–∫–ª–∞–¥–∏</h3>

            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-4">
                    <button type="button"
                            @click="activeTab = 'uk'"
                            :class="activeTab === 'uk' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞
                    </button>
                    <button type="button"
                            @click="activeTab = 'en'"
                            :class="activeTab === 'en' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá¨üáß English
                    </button>
                    <button type="button"
                            @click="activeTab = 'de'"
                            :class="activeTab === 'de' ? 'border-warning text-warning' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-2 px-4 border-b-2 font-semibold transition">
                        üá©üá™ Deutsch
                    </button>
                </nav>
            </div>

            <div>
                <div x-show="activeTab === 'uk'" class="space-y-4">
                    <input type="hidden" th:field="*{translations['uk'].lang}">
                    <input type="hidden" th:field="*{translations['uk'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            –ù–∞–∑–≤–∞ <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['uk'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            –û–ø–∏—Å
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['uk'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta –æ–ø–∏—Å (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['uk'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">–ú–∞–∫—Å–∏–º—É–º 160 —Å–∏–º–≤–æ–ª—ñ–≤</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['uk'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">–¢—ñ–ª—å–∫–∏ –º–∞–ª—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ –¥–µ—Ñ—ñ—Å–∏</p>
                    </div>
                </div>

                <div x-show="activeTab === 'en'" class="space-y-4" style="display: none;">
                    <input type="hidden" th:field="*{translations['en'].lang}">
                    <input type="hidden" th:field="*{translations['en'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Title <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['en'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Description
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['en'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta description (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['en'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Maximum 160 characters</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['en'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Only lowercase letters, numbers and hyphens</p>
                    </div>
                </div>

                <div x-show="activeTab === 'de'" class="space-y-4" style="display: none;">
                    <input type="hidden" th:field="*{translations['de'].lang}">
                    <input type="hidden" th:field="*{translations['de'].id}">

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Titel <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['de'].title}"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"
                               required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Beschreibung
                        </label>
                        <textarea rows="4"
                                  th:field="*{translations['de'].description}"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Meta-Beschreibung (SEO)
                        </label>
                        <textarea rows="2"
                                  th:field="*{translations['de'].metaDescription}"
                                  maxlength="160"
                                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Maximal 160 Zeichen</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-900 mb-2">
                            Slug (URL) <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               th:field="*{translations['de'].slug}"
                               pattern="[a-z0-9-]+"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-warning transition font-mono"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Nur Kleinbuchstaben, Zahlen und Bindestriche</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end gap-4">
            <a href="/admin/lessons"
               class="px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition">
                –°–∫–∞—Å—É–≤–∞—Ç–∏
            </a>
            <button type="submit"
                    class="px-6 py-3 bg-warning text-gray-900 rounded-lg font-semibold hover:bg-yellow-500 transition">
                <span th:text="${isEdit} ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ —É—Ä–æ–∫'">–°—Ç–≤–æ—Ä–∏—Ç–∏</span>
            </button>
        </div>
    </form>

</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        function lessonForm() {
            return {
                // –ê—Ç—Ä–∏–±—É—Ç–∏
                selectedOptions: [],
                textValues: {},
                numberValues: {},

                // –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏
                materials: [],

                init() {
                    console.log('Lesson form initialized');

                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
                    this.loadExistingAttributes();
                    this.loadExistingMaterials();

                    // –ì–µ–Ω–µ—Ä—É—î–º–æ hidden inputs
                    this.$watch('selectedOptions', () => this.generateHiddenInputs());
                    this.$watch('textValues', () => this.generateHiddenInputs());
                    this.$watch('numberValues', () => this.generateHiddenInputs());
                    this.$watch('materials', () => this.generateMaterialsHiddenInputs(), { deep: true });
                },

                // ========== –ê–¢–†–ò–ë–£–¢–ò ==========

                loadExistingAttributes() {
                    /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                    const existingAttrs = /*[[${lesson.attributes}]]*/ [];
                    console.log('Loading existing attributes:', existingAttrs);

                    let loadedOptions = [];
                    let loadedText = {};
                    let loadedNumbers = {};

                    existingAttrs.forEach(attr => {
                        if (attr.optionId) {
                            const value = `${attr.attributeId}-${attr.optionId}`;
                            loadedOptions.push(value);
                        } else if (attr.textValue) {
                            loadedText[attr.attributeId] = attr.textValue;
                        } else if (attr.numberValue != null) {
                            loadedNumbers[attr.attributeId] = attr.numberValue;
                        }
                    });

                    this.selectedOptions = loadedOptions;
                    this.textValues = loadedText;
                    this.numberValues = loadedNumbers;

                    this.$nextTick(() => {
                        this.generateHiddenInputs();
                    });
                    /*[/]*/
                },

                updateTextValue(attributeId, value) {
                    if (value && value.trim()) {
                        this.textValues[attributeId] = value;
                    } else {
                        delete this.textValues[attributeId];
                    }
                },

                updateNumberValue(attributeId, value) {
                    if (value !== '' && value !== null) {
                        this.numberValues[attributeId] = value;
                    } else {
                        delete this.numberValues[attributeId];
                    }
                },

                getTextValue(attributeId) {
                    return this.textValues[attributeId] || '';
                },

                getNumberValue(attributeId) {
                    return this.numberValues[attributeId] || '';
                },

                generateHiddenInputs() {
                    const container = document.getElementById('attributes-hidden-inputs');
                    if (!container) return;

                    container.innerHTML = '';
                    let index = 0;

                    // Select/multiselect –∞—Ç—Ä–∏–±—É—Ç–∏
                    this.selectedOptions.forEach(value => {
                        const [attributeId, optionId] = value.split('-');

                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) &&
                            String(a.optionId) === String(optionId)
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].optionId" value="${optionId}">`;
                        index++;
                    });

                    // –¢–µ–∫—Å—Ç–æ–≤—ñ –∞—Ç—Ä–∏–±—É—Ç–∏
                    Object.keys(this.textValues).forEach(attributeId => {
                        const value = this.textValues[attributeId];
                        if (!value || !value.trim()) return;

                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) && a.textValue
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].textValue" value="${this.escapeHtml(value)}">`;
                        index++;
                    });

                    // –ß–∏—Å–ª–æ–≤—ñ –∞—Ç—Ä–∏–±—É—Ç–∏
                    Object.keys(this.numberValues).forEach(attributeId => {
                        const value = this.numberValues[attributeId];
                        if (value === '' || value === null) return;

                        let existingId = null;
                        /*[# th:if="${lesson != null and lesson.attributes != null}"]*/
                        const existing = /*[[${lesson.attributes}]]*/ [];
                        const found = existing.find(a =>
                            String(a.attributeId) === String(attributeId) && a.numberValue != null
                        );
                        if (found) existingId = found.id;
                        /*[/]*/

                        if (existingId) {
                            container.innerHTML += `<input type="hidden" name="attributes[${index}].id" value="${existingId}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].attributeId" value="${attributeId}">`;
                        container.innerHTML += `<input type="hidden" name="attributes[${index}].numberValue" value="${value}">`;
                        index++;
                    });

                    console.log('Generated', index, 'attribute inputs');
                },

                // ========== –ú–ê–¢–ï–†–Ü–ê–õ–ò ==========

                loadExistingMaterials() {
                    /*[# th:if="${lesson != null and lesson.materials != null}"]*/
                    const existingMaterials = /*[[${lesson.materials}]]*/ [];
                    console.log('Loading existing materials:', existingMaterials);

                    // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ sortOrder
                    existingMaterials.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

                    this.materials = existingMaterials.map(m => ({
                        id: m.id,
                        materialType: m.materialType,
                        title: m.title || '',
                        content: m.content || '',
                        sortOrder: m.sortOrder || 0
                    }));

                    this.$nextTick(() => {
                        this.generateMaterialsHiddenInputs();
                    });
                    /*[/]*/
                },

                addMaterial() {
                    const newOrder = this.materials.length > 0
                        ? Math.max(...this.materials.map(m => m.sortOrder || 0)) + 1
                        : 0;

                    this.materials.push({
                        id: null,
                        materialType: '',  // –í–ê–ñ–õ–ò–í–û: –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫, –Ω–µ null
                        title: '',
                        content: '',
                        sortOrder: newOrder
                    });
                    console.log('Material added, total:', this.materials.length);
                },

                removeMaterial(index) {
                    this.materials.splice(index, 1);
                    console.log('Material removed, remaining:', this.materials.length);
                },

                generateMaterialsHiddenInputs() {
                    const container = document.getElementById('materials-hidden-inputs');
                    if (!container) {
                        console.error('Materials hidden inputs container not found!');
                        return;
                    }

                    container.innerHTML = '';
                    let validIndex = 0;

                    this.materials.forEach((material) => {
                        // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –±–µ–∑ —Ç–∏–ø—É
                        if (!material.materialType || material.materialType === '') {
                            console.log('Skipping material without type:', material);
                            return;
                        }

                        if (material.id) {
                            container.innerHTML += `<input type="hidden" name="materials[${validIndex}].id" value="${material.id}">`;
                        }
                        container.innerHTML += `<input type="hidden" name="materials[${validIndex}].materialType" value="${material.materialType}">`;
                        container.innerHTML += `<input type="hidden" name="materials[${validIndex}].title" value="${this.escapeHtml(material.title || '')}">`;
                        container.innerHTML += `<input type="hidden" name="materials[${validIndex}].content" value="${this.escapeHtml(material.content || '')}">`;
                        container.innerHTML += `<input type="hidden" name="materials[${validIndex}].sortOrder" value="${material.sortOrder || 0}">`;

                        validIndex++;
                    });

                    console.log('Generated', validIndex, 'valid material inputs from', this.materials.length, 'total materials');
                },

                // ========== UTILITIES ==========

                escapeHtml(text) {
                    if (typeof text !== 'string') return text;
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return text.replace(/[&<>"']/g, m => map[m]);
                }
            }
        }
    </script>
</th:block>

</body>
</html>
